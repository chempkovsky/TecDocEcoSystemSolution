@using CarShop.Properties;
@{
    ViewBag.Title = "CarShopRestToWeb2";
    Layout = "~/Views/ByTasks/_Layout.cshtml";
}

@section headerscripts {
    <h2>20. Утилита CarShopRestToWeb.exe (2) Загрузка остатков и цен вашего магизина в стол заказов</h2>
}

<h2>Задача</h2>
Вы не пользуетесь данным решением в качестве учетной системы в своем бизнесе.
У вас есть собственная, которая вас полностью устраивает, но вам нужен интеренет-магазин.
Утилита CarShopRestToWeb.exe позволяет вести картотеку остатков и цен вашего магазина на вашем компьютере и
позволяет в пакетном режиме загрузить остатки и цены вашего магазина в картотеку интернет-магазина.
Промежуточная картотека играет важную роль как с точки зрения оптимизации <b>импорта</b>
из вашей учетной системы, так и сточки зрения <b>экспорта</b> данных в картотеку интернет-магазина.<p />

<h3>Оптимизация при импорте из вашей системы</h3>
    При импорте данных из вашей системы делается проверка по каждой товарной позиции на предмет корректности.
    Помимо номера артикула и брэнда поставщика, необходима информация, на каких автомобилях может быть установлена
    данная деталь, какие аналоги от других поставщиков эта деталь имеет и к каким конструкционным номерам данная деталь
    привязана.
    Простое внесение такого артикула в перечень остатков не даст ожидаемого результата.
    У конечного покупателя и даже у продавца должна быть возможность выйти на данную деталь либо по конструкционному номеру,
    либо по автомобилю, на котором эта деталь устанавливается, либо через просмотр аналогов.
    Такой сервис предоставляется каталогом TecDoc. Если детали в TecDoc нет, то ее нет для конечного покупателя
    и не важно, что в остатках она есть.<p />

    Поэтому при импорте будут отвергнуты все товарные позиции, которых не окажется в TecDoc или в расширении TecDoc или в картотеке поставщиков.
<div class="alert alert-info">
    Не надо бояться, что вы ничего не сможете залить!!! Если нумерация ваших товарных позиций совпадает с нумерацией
    товарных позиций оптовых поставщиков (Шатэ-М, Автоспейс и т.п.), то утилита CarShopRestToWeb.exe сможет это сделать!!!!
</div>

    @Html.ActionLink("19. Утилита CarShopRestToWeb.exe (1)", "CarShopRestToWeb", "ByTasks", routeValues: null, htmlAttributes: new { @class = "btn btn-info btn-xs" })
    Перейдите по ссылке, чтобы прочесть о расширении каталога TecDoc<p />

<h3>Оптимизация при экспорте в интернет-магазин</h3>
    Оптимизация по экпорту данных: нет нужды перевыгружать карточку в стол заказов, 
    если с последней выгрузки по этой карточке ни цена, ни количество не изменились.
    Утилита CarShopRestToWeb.exe знает, когда и что менялось и будет отсылать только те позиции, 
    по которым изменились количество или цена.

<h2>РОЛЬ: администратор подразделения</h2>
Право на внесение изменений присвоено роли администратор подразделения. <p />

<h2>Регламент</h2>
Регламент разделяется на две подзадачи: <br />
Первое: формирование картотеки остатков и цен<br />
Второе: Выгрузка артикулов в картотеку интернет-магазина.<p />

В свою очередь, формирование картотеки может выполняться прямым добавлением или может выполняться пакетно
загрузкой EXCEL или CSV файлов.

<h3>Регистрация магазина в картотеке утилиты CarShopRestToWeb.exe</h3>
Прежде чем выполнять импорт/экспорт необходимо зарегистрировать ваш магазин в картотеке CarShopRestToWeb.exe.
Дело в том что, картотека CarShopRestToWeb.exe может обсуживать несколько торговых точек и вести остатки паралельно.
Раз это так, то каждую торговую точку необходимо зарегистрировать. Ниже прниводятся шаги регистрации.<p />

1. Запустите программу CarShopRestToWeb.exe <p />
2. Выполните вход в локальную картотеку.<p />
Для этого воспользуйтесь пунктом меню "Сервис/Открыть БД соответствия".
Появится блок диалога и вы должны ввести имя компьютера (или IP-адрес), где размещен сервер MySQL.
Введите пароль в соответствующее поле и нажмите OK.
Появится блок диалога с перечнем баз данных на сервере MySQL. Выберите "carshopmapping" и нажмите OK.<p />
3. Откройте форму "Магазины и остатки" через пункт меню "Сервис/Цены и остатки по магазинам".
Кликните на кнопку <b>Обновить</b> в верхнем пенале, чтобы получить перечень уже внесенных.
В верхнем пенале воспользуйтесь кнопками "Добавить", "Удалить", "Изменить" для редактирования атрибутов магазинов.
Для внесения новой записи кликните "Добавить", при этом появится блок диалога "Атрибуты подразделения".
Внесите ID записи -- целое число, Наименование своего магазина. 
В поле ID для web-магазина вы вносите данные которые вам пришлет администратор сайта, когда зарегистрирует 
ваш интернет-магазин. Помимо этого администратор сайта пришлет вам пароль, пользователя и базовый HTTP адрес.
Все остальные поля оставьте без изменения. В конце нажмите кнопку OK.

<h3>Формирование картотеки прямым добавлением</h3>
<div class="alert alert-warning">
    Требует установки TecDoc
</div>

1. Запустите программу CarShopRestToWeb.exe <p />
2. Выполните вход в локальную картотеку.<p />
Для этого воспользуйтесь пунктом меню "Сервис/Открыть БД соответствия".
Появится блок диалога и вы должны ввести имя компьютера (или IP-адрес), где размещен сервер MySQL.
Введите пароль в соответствующее поле и нажмите OK.
Появится блок диалога с перечнем баз данных на сервере MySQL. Выберите "carshopmapping" и нажмите OK.<p />
3. Откройте форму "Магазины и остатки" через пункт меню "Сервис/Цены и остатки по магазинам".
Кликните на кнопку <b>Обновить</b> в верхнем пенале, чтобы получить перечень уже внесенных.
В верхнем пенале станьте на строку, которая соответствует вашему магазину.
В нижнем пенале Кликните кнопку <b>(...)</b> в строке "Остатки", чтобы получить перечень ранее внесенных записей.
Заметим, что за каждой товарной позицией закрепляется, артикул/брэнд вашего магазина, 
артикул/брэнд/EAN/Наименование TecDoc, цена, кол-во. Есть еще три важных поля дата последнего обновления записи, 
дата последней отгрузки в картотеку интернет-магазина и столбец содержащий текст ошибки, если такая возникает
при экспорте в картотеку интернет-магазина. При внесении или редактировании данных дата последнего обновления записи 
всегда больше чем дата последней отгрузки в картотеку интернет-магазина. Именно таки образом отслеживается, 
была ли отгружена запись после редактирования.<p />
При внесении новой карточки вам предоставляется возможность редактировать артикул/брэнд вашего магазина, цена и кол-во.
Поля артикул/брэнд/EAN/Наименование TecDoc вы можете заполнить только через выбор. Правка данных в этой части запрещена.

<h3>Формирование картотеки пакетно</h3>
<div class="alert alert-info">
    Может исполняться без TecDoc. Для этого необходимо со страницы
    @Html.ActionLink("Загрузки", "Dounloads", "HowTo", routeValues: null, htmlAttributes: new { @class = "btn btn-success btn-xs" })
    скачать и развернуть <b>Базу MySql</b>. Выполните первоначальный импорт с парой включенных флагов<br /> 
    <b>"Проверять артикулы используя или в TecDoc или картотеку поставщиков"</b> <br /> 
    и<br /> 
    <b>"При проверке не использовать TecDoc, но только картотеку поставщиков"</b> <p /> <p /> 
    Если у вас установлен TecDoc,
    После  завершения процесса можете сразу же повторно запустить процесс выключенным флагом<br /> 
    <b>"При проверке не использовать TecDoc, но только картотеку поставщиков"</b>. <br /> 
    и включенным флагом <br /> 
    <b>"Проверять артикулы используя или в TecDoc или картотеку поставщиков"</b> <br /> 
</div>

1. Запустите программу CarShopRestToWeb.exe <p />
2. Выполните вход в локальную картотеку.<p />
Для этого воспользуйтесь пунктом меню "Сервис/Открыть БД соответствия".
Появится блок диалога и вы должны ввести имя компьютера (или IP-адрес), где размещен сервер MySQL.
Введите пароль в соответствующее поле и нажмите OK.
Появится блок диалога с перечнем баз данных на сервере MySQL. Выберите "carshopmapping" и нажмите OK.<p />
3. Откройте форму "Магазины и остатки" через пункт меню "Сервис/Цены и остатки по магазинам".
Кликните на кнопку <b>Обновить</b> в верхнем пенале, чтобы получить перечень уже внесенных.
В верхнем пенале станьте на строку, которая соответствует вашему магазину.
В нижнем пенале Кликните кнопку <b>(...)</b> в строке "Остатки", чтобы получить перечень ранее внесенных записей.
Воспользуйтесь кнопкой "Импорт EXCEL или CSV". При этом появится блок диалога "Импорт EXCEL или CSV".
На данном блоке кликните кнопку "Выбрать файл". После выбора файла выберите книгу из появившегоса списка.
После этого кликните "Читать файл". После того как вы прочли файл, вы должны задать правила конвертирования
указав каким данным какой столбец соответствует. <p />
Для того, чтобы задать правила конвертирования кликните кнопку "Правила конвертирования". 
При этом появится форма "Правила конвертирования". 
<div class="alert alert-warning">
    На данной форме перейдите на вкладку отображения полей. Заполнете табличку правильным соответствием
    функционального типа столбца и имени столбца. Обязательными к заполнению являются следующие функциональные типы:<br />
    1. Столбец артикула карточки поставщика<br />
    2. Столбец брэнда карточки поставщика<br />
    3. Столбец Кол-ва<br />
    4. Столбец цены
</div>
Остальные столбцы будут определены автоматически в процессе импорта данных.<p />
<div class="alert alert-warning">
    Обязательно перейдите на вкладку "Условия" и внесите минимум одну запись<p />
    ID = 100<br />
    Тип обработки = Без разделителя<br />
    Условия разделителя = преффикс-артикул<br />
    Значение разделителя=символ подчеркивания "_" <br />
    Условия преффикса = копировать преффикс<br />
    Значение преффикса = оставить пустым <br />
    Значение замены преффикса = оставить пустым <br />
    Условия суффикса = взять брэнд<br />
    Значение суффикса = оставить пустым <br />
    Значение замены суффикса = оставить пустым <br />
</div>

<div class="alert alert-success">
    После завершения настройки конвертирования обязательно кликните кнопку OK.
    При этом в папке запуска программы будет создан файл с именем<br />
    BranchCnvRulesX.xml, <br />
    где X -- это целое число -- номер записи, который был присвоен при
    регистрация магазина в картотеке утилиты CarShopRestToWeb.exe.
</div>

Если настройка конвертирования готова можно запустить процесс конвертирования кликнув по кнопке
"Импортировать данные с текущей записи" или "Импортировать все данные". 
При этом появится блок диалога "Импортировать файл".<p />

<ul class="list-group">
    <li class="list-group-item list-group-item-text">
        Если ваша учетная система ведет цены в EURO, то в поле курс вы должны указать курс EURO, если в USD, то курс USD,
        если в Бел.Рублях, то курс должен быть равен 1.
        <p />

        Укажите округление. На момент написания данной статьи округлялось до 1000 Бел.Рублей, если до одного рубля, то поставьте 1,
        если до 10-ти рублей то поставьте 10. Если до 1 копейки, то поставьте 0.01.
        <p />

        Зачастую цены в интернет ниже розничных. Если у вас совпадают, то поставьте коэффициент уценки равным 1,
        если цены в интернет ниже на 5%, чем розничные, то поставьте 0,95,
        если цены в интернет выше на 15%, чем розничные, то поставьте 1,15.
        <p />

    </li>
    <li class="list-group-item">
        При самом первом запуске импорта флаг<br/> 
        <b>"Проверять артикулы используя или в TecDoc или картотеку поставщиков"</b> <br /> должен быть включен.
        В противном случае вы не сможете импортировать ни одной записи. 
        Если при этом флаг <br /> 
        <b>"При проверке не использовать TecDoc ..."</b> выключен.<br /> 
        И флаг <br />
        <b>"Формировать частные не TecDoc артикулы ..."</b> выключен.<p />
        <div class="alert alert-info">
            Включенный  флаг <b>"Проверять артикулы используя или в TecDoc или картотеку поставщиков"</b> <br />
            И отключенный флаг <b>"При проверке не использовать TecDoc ..."</b> <br />
            требует установки TecDoc на вашем компьютере.
        </div>
        В этом случае алгоритм импорта следующий:<p />
        <ul class="list-group">
            <li class="list-group-item">
                1. По артикулу и брэнду  утилита пытается найти запись в своей картотеке остатков и цен магазина.
                Если запись найдена, то проводится обновление цены и остатка.<br />
               Иначе - шаг 2.
            </li>
            <li class="list-group-item">
                2. Если запись не найдена, то делается попытка по артикулу и брэнду  найти товарную позицию в TecDoc.
                Если такая нашлась, то в картотеку остатков и цен магазина добавляется новая запись состоящая из артикула и брэнда магазина и из
                артикула, брэнда, наименования и EAN из TecDoc.<br />
               Иначе - шаг 3.
            </li>
            <li class="list-group-item">
                3. Если запись в TecDoc не найдена, то делается попытка найти запись в картотеке расширение каталога TecDoc
                утилиты CarShopRestToWeb.exe. Если запись найдена, то в картотеку остатков и цен магазина добавляется новая запись
                состоящая из артикула и брэнда  магазина и из артикула, брэнда, наименования и EAN из картотеки расширения.<br />
               Иначе - шаг 4.
            </li>
            <li class="list-group-item">
                4. Если запись в картотеке расширение каталога TecDoc не найдена и флаг "Искать определение артикула в Шатэ-М", то делается
                запрос к интернету для поиска этого артикула. Если артикул найден, то делается проход по аналогам с попыткой найти такой аналог,
                который есть в TecDoc. Если аналог найден, то в картотеке расширения TecDoc появляется новая запись. И после этого
                создается запись с остатком и ценой. Если аналогов в интернет не найдено, то делается проход по конструкционным номерам,
                с попыткой найти аналог по конструкционному номеру. Если аналог найден, то в картотеке расширения TecDoc появляется новая запись. И после этого
                создается запись с остатком и ценой.<br />
               Иначе - шаг 5.
            </li>
            <li class="list-group-item">
                5. Если запись в картотеке расширение каталога TecDoc не найдена и флаг "Искать определение артикула в Шатэ-М", то делается
                запрос к интернету для поиска этого артикула. Если артикул найден, то делается проход по аналогам с попыткой найти такой аналог,
                который есть в TecDoc. Если аналог найден, то в картотеке расширения TecDoc появляется новая запись. И после этого
                создается запись с остатком и ценой. Если аналогов в интернет не найдено, то делается проход по конструкционным номерам,
                с попыткой найти аналог по конструкционному номеру. Если аналог найден, то в картотеке расширения TecDoc появляется новая запись. И после этого
                создается запись с остатком и ценой.<br />
                Иначе - шаг 6.
            </li>
            <li class="list-group-item">
                6. Если запись в картотеке расширение каталога TecDoc не найдена и флаг "Искать определение артикула в Автоспейс", то делается
                запрос к интернету для поиска этого артикула. Если артикул найден, то делается проход по аналогам с попыткой найти такой аналог,
                который есть в TecDoc. Если аналог найден, то в картотеке расширения TecDoc появляется новая запись. И после этого
                создается запись с остатком и ценой. Если аналогов в интернет не найдено, то делается проход по конструкционным номерам,
                с попыткой найти аналог по конструкционному номеру. Если аналог найден, то в картотеке расширения TecDoc появляется новая запись. И после этого
                создается запись с остатком и ценой.<br />
                Иначе - шаг 7.
            </li>
            <li class="list-group-item">
                7. Если запись в картотеке расширение каталога TecDoc не найдена и флаг "Искать определение артикула в L-Auto", то делается
                запрос к интернету для поиска этого артикула. Если артикул найден, то делается проход по аналогам с попыткой найти такой аналог,
                который есть в TecDoc. Если аналог найден, то в картотеке расширения TecDoc появляется новая запись. И после этого
                создается запись с остатком и ценой. Если аналогов в интернет не найдено, то делается проход по конструкционным номерам,
                с попыткой найти аналог по конструкционному номеру. Если аналог найден, то в картотеке расширения TecDoc появляется новая запись. И после этого
                создается запись с остатком и ценой.<br />
                Иначе - шаг 8.
            </li>
            <li class="list-group-item">
                8. Если запись в картотеке расширение каталога TecDoc не найдена и флаг "Искать определение артикула в Motex", то делается
                запрос к интернету для поиска этого артикула. Если артикул найден, то делается проход по аналогам с попыткой найти такой аналог,
                который есть в TecDoc. Если аналог найден, то в картотеке расширения TecDoc появляется новая запись. И после этого
                создается запись с остатком и ценой. Если аналогов в интернет не найдено, то делается проход по конструкционным номерам,
                с попыткой найти аналог по конструкционному номеру. Если аналог найден, то в картотеке расширения TecDoc появляется новая запись. И после этого
                создается запись с остатком и ценой.<br />
                Иначе - шаг 9.
            </li>
            <li class="list-group-item">
                9. Если аналог не найден, то данная товарная позиция не импортируется и запись помечается,
                как не принятая к импорту. Это заносится в дополнительный столбец импортируемого файла.
            </li>
        </ul>
        Если флаг
        <b>"Формировать частные не TecDoc артикулы ..."</b> включен. то после шага (7) выполняется внесение артикула в картотеку артикулов, 
        у которых нет аналогов в TecDoc (это клей, домкраты и т.п.). 
        И после этого создается запись с остатком и ценой в картотеке магазина.<p /><p />
        Если флаг
        <b>"Пердварительно проверить в картотеке частных артикулов"</b> включен, то шаг (2) и шаг (3) меняются местами: 
        перед шагом (2) выполняется шаг (3).


   </li>

   <li class="list-group-item">
        <div class="alert alert-info">
            Если включен флаг <b>"Проверять артикулы используя или в TecDoc или картотеку поставщиков"</b> <br />
            И включен флаг <b>"При проверке не использовать TecDoc ..."</b> <br />
            НЕ ТРЕБУЕТ установки TecDoc на вашем компьютере.
        </div>
       В этом случае алгоритм импорта следующий:<p />
       <ul class="list-group">
           <li class="list-group-item">
               1. По артикулу и брэнду  утилита пытается найти запись в своей картотеке остатков и цен магазина.
               Если запись найдена, то проводится обновление цены и остатка.<br />
               Иначе - шаг 2.
           </li>
           <li class="list-group-item">
               2. По артикулу и брэнду магазина утилита пытается найти запись в своей картотеке остатков и цен поставщиков.
               Если запись найдена, то проводится обновление цены и остатка.<br />
               Иначе - шаг 3.
           </li>
           <li class="list-group-item">
               3. Если запись в картотеке остатков и цен поставщиков не найдена, то делается попытка найти запись в картотеке 
               расширение каталога TecDoc утилиты CarShopRestToWeb.exe. Если запись найдена, то в картотеку остатков и цен магазина 
               добавляется новая запись состоящая из артикула и брэнда  магазина и из артикула, брэнда, 
               наименования и EAN из картотеки расширения.<br />
               Иначе - шаг 4.
           </li>
           <li class="list-group-item">
               4. Если аналог не найден, то данная товарная позиция не импортируется и запись помечается,
               как не принятая к импорту. Это заносится в дополнительный столбец импортируемого файла.
           </li>
       </ul>
       <p />
       Флаг
       <b>"Формировать частные не TecDoc артикулы ..."</b> не действует и считается выключенным.<p />
       Если флаг
       <b>"Пердварительно проверить в картотеке частных артикулов"</b> включен, то шаг (2) и шаг (3) меняются местами:
       перед шагом (2) выполняется шаг (3).

</li>
</ul>

    <p />

<div class="alert alert-warning">
    <b>Замечание:</b> Если флаг <b>"Проверять артикулы используя ..."</b> выключен, то флаг
    <b>"Искать определение артикула в Шатэ-М, Автоспейс, L-Auto, Motex"</b> работать не будет.
</div>
<div class="alert alert-warning">
    <b>Замечание:</b> Если флаг <b>"Проверять артикулы используя ..."</b> выключен, то флаг
    <b>"При проверке не использовать TecDoc ..."</b> работать не будет.
</div>
<div class="alert alert-warning">
    <b>Замечание:</b> Если флаг <b>"Проверять артикулы используя ..."</b> выключен, то флаг
    <b>"Формировать частные не TecDoc артикулы ..."</b> работать не будет.
</div>
<div class="alert alert-warning">
    <b>Замечание:</b> Если флаг <b>"При проверке не использовать TecDoc ..."</b> включен, то флаг
    <b>"Формировать частные не TecDoc артикулы ..."</b> работать не будет.
</div>


    <p />

    <b>Замечание:</b> Первоначальная загрузка выполняется очень медленно. Наберитесь терпения. После завершения процесса, просмотрите последний столбец
    и проанализируйте почему артикул не загрузился. Уверяю вас, обнаружите массу интересного.
    Предположим, что в результате серии иттераций (или попыток) вы смирились, с тем что часть артикулов не будет попадать в интернет-магазин.

    Тогда при очередной загрузке остатков отключите флаг <b>"Проверять артикулы используя ..."</b> . Это сильно ускорит процесс импорта.
    Отключать этот флаг разумно, когда между последним и текущим импортом в вашу картотеку не было добавлено новых товарных позиций.

    <h4>Экспорт остатков в интернет магазин</h4>
    1. Запустите программу CarShopRestToWeb.exe
    <p />
    2. Выполните вход в локальную картотеку.
    <p />
    Для этого воспользуйтесь пунктом меню "Сервис/Открыть БД соответствия".
    Появится блок диалога и вы должны ввести имя компьютера (или IP-адрес), где размещен сервер MySQL.
    Введите пароль в соответствующее поле и нажмите OK.
    Появится блок диалога с перечнем баз данных на сервере MySQL. Выберите "carshopmapping" и нажмите OK.
    <p />
    3. Откройте форму "Магазины и остатки" через пункт меню "Сервис/Цены и остатки по магазинам".
    Кликните на кнопку
    <b>Обновить</b> в верхнем пенале, чтобы получить перечень уже внесенных.
    В верхнем пенале станьте на строку, которая соответствует вашему магазину.
    В нижнем пенале кликните кнопку "Переслать остатки и цены". Откроется блок диалога "Загрузка остатков на Web-узел".
    Кликните кнопку старт для запуска процесса

